//
// Created by mumumusuc on 19-2-10.
//
#include <linux/kernel.h>
#include <linux/errno.h>
#include <linux/module.h>
#include <linux/slab.h>
#include <linux/fb.h>
#include <linux/uaccess.h>
#include "ssd1306.h"

// THIS IS STUPID!
const char logo[1024] = {
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x50, 0xf0, 0xf8, 0xf8, 0xf8, 0xf8, 0xf8,
        0xfc, 0x7c, 0xf8, 0xfc, 0xf8, 0xfc, 0xf8, 0xf8, 0xf0, 0xf0, 0xe0, 0xc0, 0x00, 0x00,
        0x00, 0x00, 0xc0, 0xe0, 0xf0, 0xf0, 0xf8, 0xf8, 0xfc, 0xf8, 0xfc, 0xf8, 0x7c, 0xfc, 0xf8, 0xf8, 0xf8, 0xf8,
        0xf8, 0xf0, 0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x1f, 0x3f, 0x7f, 0xff, 0xff,
        0xff, 0xff, 0xfe, 0xfe, 0xfd, 0xf9, 0xfb, 0xf7, 0x67, 0x0f, 0x1f, 0x0f, 0x00, 0x00,
        0x00, 0x02, 0x0f, 0x1f, 0x0f, 0x67, 0xf7, 0xfb, 0xf9, 0xfd, 0xfe, 0xfe, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f,
        0x0f, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf1,
        0xf1, 0xf1, 0xfb, 0x7b, 0x3b, 0x19, 0x01, 0x60, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xfc,
        0xfc, 0xfc, 0xfc, 0xf8, 0xf8, 0xf0, 0x41, 0x11, 0x31, 0x73, 0xf3, 0xf3, 0xf1, 0xf1, 0xe1, 0xc0, 0x80, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x80, 0x88, 0x0f, 0x0f, 0x07, 0x83,
        0xe1, 0xf1, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xfc, 0xf8, 0xf9, 0xf1, 0xe1, 0x03, 0x03,
        0x03, 0x83, 0xf3, 0xf9, 0xf9, 0xfc, 0xfc, 0xfc, 0xfc, 0xfc, 0xf8, 0xf9, 0xf3, 0xe3, 0x87, 0x0f, 0x0f, 0x8c,
        0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xfe, 0xff, 0xff, 0xff, 0x7f, 0x00, 0x00, 0x04, 0x3f,
        0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x0f, 0x00, 0x00,
        0x00, 0x03, 0x0f, 0x3f, 0x7f, 0x7f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x3f, 0x00, 0x00, 0x3f,
        0xff, 0xff, 0xff, 0xfe, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x07, 0x43, 0xf0, 0xf8, 0xf8, 0xf8, 0xf0,
        0xf0, 0xe0, 0xc1, 0x81, 0x01, 0x01, 0x01, 0xf8, 0xfc, 0xfe, 0xff, 0xff, 0xff, 0xff,
        0xff, 0xff, 0xff, 0xff, 0xfe, 0xfc, 0xf8, 0x00, 0x01, 0x01, 0xc0, 0xe0, 0xf0, 0xf8, 0xf8, 0xfc, 0xfc, 0xfc,
        0xf9, 0x03, 0x03, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x07, 0x0f, 0x1f, 0x3f, 0x7f,
        0x7f, 0x7f, 0x7f, 0x7f, 0x7e, 0x00, 0x00, 0x01, 0x07, 0x0f, 0x0f, 0x9f, 0x9f, 0x9f,
        0x9f, 0x9f, 0x9f, 0x8f, 0x0f, 0x07, 0x03, 0x00, 0x7c, 0x7f, 0xff, 0xff, 0x7f, 0x7f, 0x7f, 0x3f, 0x1f, 0x0f,
        0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x0f, 0x1f, 0x1f, 0x3f, 0x3f, 0x3f,
        0x3f, 0x3f, 0x1f, 0x1f, 0x0f, 0x0f, 0x06, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

static struct fb_fix_screeninfo ssd1306_fb_fix = {
        .id             = "SSD306_128_64",
        .type           = FB_TYPE_PACKED_PIXELS,
        .visual         = FB_VISUAL_MONO10,
        .xpanstep       = 0,
        .ypanstep       = 0,
        .ywrapstep      = 0,
        .accel          = FB_ACCEL_NONE,
        .line_length    = DISPLAY_LINE,
        .smem_len       = DISPLAY_SIZE,
};

static struct fb_var_screeninfo ssd1306_fb_var = {
        .bits_per_pixel = 1,
        .xres           = DISPLAY_WIDTH,
        .yres           = DISPLAY_HEIGHT,
        .xres_virtual   = DISPLAY_WIDTH,
        .yres_virtual   = DISPLAY_HEIGHT,
        .red.length     = 1,
        .red.offset     = 0,
        .green.length   = 1,
        .green.offset   = 0,
        .blue.length    = 1,
        .blue.offset    = 0,
};

static int ssd1306_fb_open(struct fb_info *info, int user) {
//    struct display *display = info->par;
    printk(KERN_INFO "[%s] \n", __func__);
//    display_reset(display);
//    display_turn_on(display);
    return 0;
}

static int ssd1306_fb_release(struct fb_info *info, int user) {
    printk(KERN_INFO "[%s] user = %d\n", __func__, user);
    if (user == 1) {
        info->fbops->fb_check_var(&ssd1306_fb_var, info);
    }
    return 0;
}

static ssize_t ssd1306_fb_write(struct fb_info *info, const char __user *buf, size_t count, loff_t *ppos) {
    ssize_t ret = 0;
    struct display *display = info->par;
    //ssize_t ret = fb_sys_write(info, buf, count, ppos);
    unsigned long p = *ppos;
    void *dst;
    int err = 0;
    unsigned long total_size;
    if (info->state != FBINFO_STATE_RUNNING)
        return -EPERM;
    total_size = info->screen_size;
    if (total_size == 0)
        total_size = info->fix.smem_len;
    if (p > total_size)
        return -EFBIG;
    if (count > total_size) {
        err = -EFBIG;
        count = total_size;
    }
    if (count + p > total_size) {
        if (!err)
            err = -ENOSPC;

        count = total_size - p;
    }
    dst = (void __force *) (info->screen_base + p);

    if (info->fbops->fb_sync)
        info->fbops->fb_sync(info);
    if (copy_from_user(dst, buf, count))
        err = -EFAULT;
    if (!err)
        *ppos += count;
    ret = (err) ? err : count;
    if (ret == count)
        display_update(display, (u8 *) dst, count);
    return ret;
}

/*
static int ssd1306_fb_sync(struct fb_info *info) {
    struct display *display = info->par;
    display_update(display, info->screen_buffer, display->vmem_size);
    return 0;
}
*/
static int ssd1306_fb_blank(int blank, struct fb_info *info) {
    struct display *display = info->par;
    //printk(KERN_DEBUG "[%s] %d\n", __func__, blank);
    if (blank == FB_BLANK_UNBLANK) {
        mutex_lock(&display->mem_mutex);
        memmove(display->vmem, logo, sizeof(logo));
        mutex_unlock(&display->mem_mutex);
        display_update(display, NULL, sizeof(logo));
    } else if (blank == FB_BLANK_POWERDOWN) {
        display_turn_off(display);
    } else if (blank == FB_BLANK_NORMAL) {
        display_reset(display);
        display_turn_on(display);
        display_clear(display);
    }
    return 0;
}

static void ssd1306_fb_deferred_io(struct fb_info *info, struct list_head *list) {
    struct display *display = info->par;
    display_update(display, info->screen_buffer, 0);
}

static int ssd1306_fb_check_var(struct fb_var_screeninfo *var, struct fb_info *info) {
    struct display *display = info->par;
    /*
    printk(KERN_DEBUG "[%s] size[%d,%d], vsize[%d,%d], offset[%d,%d]\n",
           __func__,
           var->xres,
           var->yres,
           var->xres_virtual,
           var->yres_virtual,
           var->xoffset,
           var->yoffset);*/
    info->var = *var;
    spin_lock(&display->dirty_locker);
    display->dirty_col_start = info->var.xoffset;
    display->dirty_col_end = info->var.xoffset + info->var.xres - 1;
    display->dirty_row_start = info->var.yoffset;
    display->dirty_row_end = info->var.yoffset + info->var.yres - 1;
    spin_unlock(&display->dirty_locker);
    return 0;
}

static struct fb_deferred_io ssd1306_defio = {
        .delay          = HZ / 30,
        .deferred_io    = ssd1306_fb_deferred_io,
};

static struct fb_ops ssd1306_fbops = {
        .owner          = THIS_MODULE,
        .fb_fillrect    = cfb_fillrect,
        .fb_copyarea    = cfb_copyarea,
        .fb_imageblit   = cfb_imageblit,
        .fb_write       = ssd1306_fb_write,
        //.fb_sync        = ssd1306_fb_sync,
        .fb_blank       = ssd1306_fb_blank,
        .fb_open        = ssd1306_fb_open,
        .fb_release     = ssd1306_fb_release,
        .fb_check_var   = ssd1306_fb_check_var,
};

int display_driver_probe(struct device *device, struct display *display, struct interface *interface) {
    int ret = 0;
    char *vmem;
    struct fb_info *fbinfo = framebuffer_alloc(0, device);
    printk(KERN_DEBUG "[%s]\n", __func__);
    if (IS_ERR_OR_NULL(fbinfo)) {
        printk(KERN_ALERT "[%s] fbinfo alloc error\n", __func__);
        return -ENOMEM;
    }
    vmem = vzalloc(DISPLAY_SIZE);
    if (IS_ERR_OR_NULL(vmem)) {
        ret = -ENOMEM;
        goto alloc_failed;
    }
    // init fb data
    fbinfo->var = ssd1306_fb_var;
    fbinfo->fix = ssd1306_fb_fix;
    fbinfo->screen_buffer = vmem;
    fbinfo->fix.smem_start = (unsigned long) vmem;
    fbinfo->fbops = &ssd1306_fbops;
    fbinfo->fbdefio = &ssd1306_defio;
    fb_deferred_io_init(fbinfo);
    display->vmem = vmem;
    ret = display_init(display, interface);
    if (ret < 0) {
        goto alloc_failed;
    }
    // register
    fbinfo->par = display;
    display->par = fbinfo;
    ret = register_framebuffer(fbinfo);
    if (ret < 0) {
        dev_err(device, "[%s] register framebuffer failed \n", __func__);
        goto register_failed;
    }
    printk(KERN_DEBUG "[%s] register fb%d\n", __func__, fbinfo->node);
    return ret;

    register_failed:
    pr_err("register failed\n");
    display_deinit(display);
    alloc_failed:
    pr_err("alloc failed\n");
    framebuffer_release(fbinfo);
    return ret;
}

void dislay_driver_remove(struct display *display) {
    struct fb_info *fbinfo = display->par;
    printk(KERN_DEBUG "[%s]\n", __func__);
    fb_deferred_io_cleanup(fbinfo);
    unregister_framebuffer(fbinfo);
    framebuffer_release(fbinfo);
    display->vmem = NULL;
    display_deinit(display);
}

// module methods
static int __init ssd1306_init(void) {
    int ret = 0;
    ret = display_driver_spi_init();
    //ret = display_driver_i2c_init();
    return ret;
}

static void __exit ssd1306_exit(void) {
    display_driver_spi_exit();
    //display_driver_i2c_exit();
}

module_init(ssd1306_init)
module_exit(ssd1306_exit)
MODULE_LICENSE("GPL");
MODULE_AUTHOR("mumumusuc");